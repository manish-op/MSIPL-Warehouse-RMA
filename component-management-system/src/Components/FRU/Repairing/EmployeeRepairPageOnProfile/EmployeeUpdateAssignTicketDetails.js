import { Form, Button, Select, Card, Descriptions, Divider, message } from "antd";
import { useEffect, useState } from "react";
import { useTicketDetails } from "../../RepairingContext/RepairingContext";
import ItemRepairingStatusAPI from "../../../API/RepairingOption/ItemRepairingStatusAPI";
import UpdateTicketDetailsAPI from "../../../API/FRU/EmployeeAssignItems/UpdateTicketDetailsAPI";

// A constant to hold the labels for our description items for cleaner code
const descriptionItemsConfig = [
  { key: 'id', label: 'Ticket ID' },
  { key: 'serialNo', label: 'Serial No' },
  { key: 'rmaNo', label: 'RMA No' },
  { key: 'generatedDate', label: 'Generated Date' },
  { key: 'ticketGeneratedBy', label: 'Ticket Generated By' },
  { key: 'tech_Assign_Date', label: 'Ticket Assign Date' },
  { key: 'technician_Name', label: 'Engineer' },
  { key: 'assignByManager', label: 'Assigned By' },
  { key: 'lastUpdateDate', label: 'Last Update Date' },
  { key: 'statusOption', label: 'Current Ticket Status', span: 2 },
  { key: 'regionName', label: 'Region' },
  { key: 'system', label: 'System' },
  { key: 'keywordName', label: 'Keyword' },
  { key: 'subKeywordName', label: 'Sub Keyword' },
  { key: 'warrantyDetails', label: 'Warranty' },
  { key: 'faultDetails', label: 'Fault Detail', span: 3 },
  { key: 'faultRemark', label: 'Fault Remark', span: 3 },
];

function EmployeeUpdateAssignTicketDetails() {
  const [form] = Form.useForm();
  const [repairingStatus, setRepairingStatus] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const { ticketUpdateDetailsForEmployee, setTicketUpdateDetailsForEmployee } = useTicketDetails();

  // API call to get the status options
  useEffect(() => {
    const fetchRepairingStatus = async () => {
      try {
        const data = await ItemRepairingStatusAPI();
        if (data) {
          setRepairingStatus(data);
        }
      } catch (error) {
        message.error("Failed to load repairing status options.");
      }
    };
    fetchRepairingStatus();
  }, []);
  
  // When the selected ticket changes, reset the form's status field
  useEffect(() => {
    form.resetFields(['repairStatus']);
  }, [ticketUpdateDetailsForEmployee, form]);


  const onFinish = async (values) => {
    if (!ticketUpdateDetailsForEmployee?.id) {
        message.error("No ticket selected.");
        return;
    }
    
    setIsLoading(true);
    const data = {
      id: ticketUpdateDetailsForEmployee.id, // Get ID from context, not the form
      ticketStatus: values.repairStatus,
    };
    
    try {
        await UpdateTicketDetailsAPI(data, setTicketUpdateDetailsForEmployee);
        message.success("Ticket updated successfully!");
        form.resetFields(['repairStatus']);
    } catch (error) {
        message.error("Failed to update ticket.");
    } finally {
        setIsLoading(false);
    }
  };

  // Generate the Description items from the config and data
  const items = descriptionItemsConfig.map(item => ({
    key: item.key,
    label: item.label,
    children: ticketUpdateDetailsForEmployee?.[item.key] || 'N/A',
    span: item.span
  }));

  return (
    <div style={{ padding: '24px', background: '#f0f2f5', height: '100%', overflow: 'auto' }}>
      <Card bordered={false} title="Update Ticket Details">
        {ticketUpdateDetailsForEmployee ? (
          <>
            <Descriptions
              bordered
              column={{ xs: 1, sm: 2, md: 3 }}
              layout="vertical"
              items={items}
            />

            <Divider orientation="left" style={{ marginTop: '32px' }}>Update Status</Divider>

            <Form
              form={form}
              layout="inline"
              onFinish={onFinish}
              style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '16px' }}
            >
              <Form.Item
                label="Change Ticket Status"
                name="repairStatus"
                rules={[{ required: true, message: "Please select a new status!" }]}
              >
                <Select
                  style={{ minWidth: "200px" }}
                  placeholder="Select a new status"
                  loading={repairingStatus.length === 0}
                  options={repairingStatus.map((status) => ({
                    value: status,
                    label: status,
                  }))}
                />
              </Form.Item>

              <Form.Item>
                <Button
                  type="primary"
                  htmlType="submit"
                  loading={isLoading}
                >
                  Update Ticket
                </Button>
              </Form.Item>
            </Form>
          </>
        ) : (
          <p style={{textAlign: 'center'}}>Select a ticket to see the details.</p>
        )}
      </Card>
    </div>
  );
}

export default EmployeeUpdateAssignTicketDetails;